# Supabase Storage Upload Contract (PUBLIC bucket)

This document describes the current end-to-end contract for image uploads.

## Environment

Backend reads these env vars:

-   `SUPABASE_URL`: Supabase project URL (e.g. `https://<project>.supabase.co`).
-   `SUPABASE_SERVICE_ROLE_KEY`: **server-only** service role key used by backend to upload/delete in Storage.
-   `SUPABASE_STORAGE_BUCKET`: bucket name (must be **PUBLIC**).

Notes:

-   `SUPABASE_PUBLIC_URL` is currently **not used** by the codebase. URLs are generated by the Supabase SDK via `getPublicUrl(path)`.
-   You do **not** need to append `/storage/v1/object/public/...` to any env var. The SDK already returns the full public object URL.

## Trial & billing rules (authoritative)

-   Trial starts on the **first successful write**: `updateCard` OR upload (`/uploads/image` or `/uploads/asset`).
-   Trial duration: 7 days (`trialStartedAt` → `trialEndsAt`).
-   After `trialEndsAt`, if not paid monthly/yearly → **writes are blocked** with `{ code: "TRIAL_EXPIRED" }`.
-   After another 7 days (`trialDeleteAt`) → card is deleted from Mongo and all Supabase objects are deleted by stored paths.
-   Claiming a card transfers ownership to a user but **does not** cancel the deletion schedule unless payment marks billing as active.

## Storage path format

Backend stores objects under a stable prefix:

-   `cards/user/{userId}/{cardId}/{kind}/{uuid}.{ext}`
-   `cards/anon/{anonHash}/{cardId}/{kind}/{uuid}.{ext}`

Where:

-   `kind` is `gallery` for gallery uploads, or one of `background|avatar|design|asset` for design assets.
-   `ext` is derived from MIME type (`jpg|png|webp`).

Actor:

-   Authenticated uploads use the `cards/user/...` prefix.
-   Anonymous uploads use the `cards/anon/...` prefix (hash of anonymousId, not the raw UUID).

## Endpoints

All endpoints accept `multipart/form-data`.

Identity requirements:

-   Either `Authorization: Bearer <jwt>` **or** `x-anonymous-id: <uuid-v4>` must be provided.

### 1) Upload gallery image

-   Route: `POST /api/uploads/image`
-   Form fields:
    -   `image` (file) – required (JPG/PNG/WebP)
    -   `cardId` (string) – required

Response (stable):

```json
{
    "url": "https://<project>.supabase.co/storage/v1/object/public/<bucket>/...",
    "path": "cards/user/<userId>/<cardId>/gallery/<uuid>.jpg",
    "total": 1,
    "limit": 5
}
```

Server-side validation:

-   MIME whitelist: `image/jpeg`, `image/png`, `image/webp`
-   Max file size: `2MB`
-   Enforces plan gallery limit before uploading.

Trial enforcement:

-   If trial is expired and not paid → returns `403 { code: "TRIAL_EXPIRED" }`.
-   If trialDeleteAt reached and not paid → returns `410 { code: "TRIAL_DELETED" }` and deletes the card/media.

Mongo writes:

-   `card.gallery[]` is backward compatible and may contain:
    -   legacy string URL entries: `"https://..."`
    -   new object entries: `{ url, path, createdAt }`
-   `card.uploads[]` always tracks every uploaded object for cleanup:
    -   `{ kind: "gallery", url, path, createdAt }`

### 2) Upload design asset (avatar/background)

-   Route: `POST /api/uploads/asset`
-   Form fields:
    -   `image` (file) – required (JPG/PNG/WebP)
    -   `cardId` (string) – required
    -   `kind` (string) – optional but recommended: `"background"` or `"avatar"`

Response (stable):

```json
{
    "url": "https://<project>.supabase.co/storage/v1/object/public/<bucket>/...",
    "path": "cards/user/<userId>/<cardId>/background/<uuid>.jpg"
}
```

Mongo writes:

-   Always appends to `card.uploads[]`:
    -   `{ kind, url, path, createdAt }`
-   If `kind` is provided, also stores path hints in `card.design` for easy replace-cleanup:
    -   `kind=background` → `design.backgroundImagePath` and `design.coverImagePath`
    -   `kind=avatar` → `design.avatarImagePath` and `design.logoPath`

Replace cleanup:

-   When uploading a new `avatar`/`background`, backend attempts a **best-effort** delete of the previous object using the stored path fields.
-   Upload success is not blocked if the cleanup fails.

## Frontend usage

### Upload calls

-   Gallery: `uploadGalleryImage(cardId, file)`
-   Design assets: `uploadDesignAsset(cardId, file, kind)` where `kind` is `"background"` or `"avatar"`.

### Rendering compatibility

Gallery rendering normalizes legacy and new formats:

-   If item is a string → use it as URL.
-   If item is an object with `{ url }` → use `url`.

Design rendering uses URL fields only:

-   Background: `design.backgroundImage` or `design.coverImage`
-   Avatar: `design.avatarImage` or `design.logo`

Paths (`design.*Path` and `uploads[].path`) are for cleanup only.
